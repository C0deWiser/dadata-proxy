# Dadata Proxy

Это Self-Hosted приложение, которое проксирует запросы к datdata.ru и 
кеширует ответы на время, которым вы сами можете управлять.

Интерфейс API полностью повторяет интерфейс API dadata.ru, то есть вам 
достаточно просто изменить `BASE_URL` в клиенте dadata и всё будет работать, 
как будто и нет никого между вами.

Использование этого прокси позволяет экономить на платных запросах к 
`clean/name` или `clean/phone`. 

Допустим одно приложение нормализовало имя `иванов иван 
иванович`, заплатив за это копеечку. В следующий раз это же или другое 
приложение нормализует это же имя, но уже бесплатно, потому что получит 
ранее сохраненный ответ.

## Управление кешированием

Если сделать запрос, как он описан в документации dadata, то ответ будет 
закеширован прокси и впредь будет возвращаться из кеша, без запросов к dadata.

Например, если в запросе передать заголовок `Cache-Control` с параметром 
`max-age` (в секундах), то ответ из кеша будет использован только если он 
не старше указанного возраста. В противном случае будет выполнен запрос к 
dadata и кеш будет обновлён свежим ответом.

```http request
POST /api/v1/clean/name HTTP/1.1
Host: example.com
Content-Type: application/json
Accept: application/json
Authorization: Token {token}
X-Secret: {secret}
Cache-Control: max-age=600

["иванов иван иванович"]
```

Поддерживаемые инструкции `Cache-Control` в запросе:

### `max-age=<seconds>`

> Задаёт максимальное время в течение которого ресурс будет считаться 
> актуальным.

Если локальный кеш старше указанного значения, то будет выполнен запрос к 
dadata, и ответ будет обновлен в кеше.

### `max-stale[=<seconds>]`

> Указывает, что клиент хочет получить ответ, для которого было превышено 
время устаревания. Дополнительно может быть указано значение в секундах, 
указывающее, что ответ не должен быть просрочен более чем на указанное 
значение.

Инструкция имеет смысл в комбинации с `max-age`. Например, кеш устарел, но 
dadata сейчас недоступна и мы не можем получить свежие данные. Значит будет 
использовать то, что есть в кеше.

Если запрос к dadata не получился, и записей подходящей свежести в кеше нет, 
то ответ будет `[]`.

### `no-cache`

> Указывает на необходимость отправить запрос на сервер для валидации 
ресурса перед использованием закешированных данных.

Запрос к dadata будет выполнен безусловно (для записей, которые старше 
`max-age`), ответ будет закеширован.

### `no-store`

> Кеш не должен хранить никакую информацию о запросе и ответе.

Ответ dadata закеширован не будет.

### `only-if-cached`

> Указывает на необходимость использования только закешированных данных. 
> Запрос на сервер не должен посылаться.

Запроса к dadata не будет. Будет возвращен ответ из кеша, если он там есть. 
Если его там нет, то ответ будет `[]`.

## Кешируемые сервисы

* [стандартизация ФИО](https://dadata.ru/api/clean/name/)
* [стандартизация телефонов](https://dadata.ru/api/clean/phone/)
* [стандартизация email](https://dadata.ru/api/clean/email/)

